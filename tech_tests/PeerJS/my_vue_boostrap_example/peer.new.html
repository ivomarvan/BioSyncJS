<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PeerJS Example</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.31"></script>
<script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
</head>
<body>
<div id="app" class="container py-5">
    <nav class="navbar navbar-dark bg-primary d-flex justify-content-center">
        <span class="navbar-brand mb-0 h1">PeerJS minimal example {{ name }}</span>
    </nav>
      
  <!-- Connection Panel -->
  <div class="card mt-4">
    <div class="card-header">Connection</div>
    <div class="card-body">
      <div class="mb-3">
        <label for="myId" class="form-label">My ID</label>
        <input type="text" class="form-control" id="myId" v-model="myId" readonly>
      </div>
      <div class="mb-3">
        <label for="partnerId" class="form-label">Partner's ID</label>
        <input type="text" class="form-control" id="partnerId" v-model="partnerId">
      </div>
      <button class="btn btn-primary" @click="connect" v-if="!isConnected">Connect</button>
      <button class="btn btn-danger" @click="connect" v-else>Disconnect</button>

      <div class="mt-3">
        <label for="status" class="form-label">Status</label>
        <input type="text" class="form-control" id="status" v-model="status" readonly>
      </div>
    </div>
  </div>

  <!-- Send Message Panel -->
  <div class="card mt-4">
    <div class="card-header">Send message</div>
    <div class="card-body">
      <div class="mb-3">
        <label for="messageToSend" class="form-label">Message to send</label>
        <input type="text" class="form-control" id="messageToSend" v-model="message">
      </div>
      <button class="btn btn-primary" @click="sendMessage">Send</button>
    </div>
  </div>

  <!-- Received Messages Panel -->
  <div class="card mt-4">
    <div class="card-header">Received messages</div>
    <div v-for="msg in receivedMessages" :class="{'text-primary': msg.sender, 'text-danger': !msg.sender}">
      <p>{{ msg.message }}</p>
    </div>    
  </div>
</div>

<script>
  const { createApp } = Vue;
  createApp({
    data() {
      return {
        myId: '',
        partnerId: '',
        message: '',
        status: 'Disconnected',  // Opraveno na správný výchozí text
        receivedMessages: [],
        peer: null,
        conn: null
      };
    },
    created() {
      const urlParams = new URLSearchParams(window.location.search);
      this.myId = urlParams.get('my_id') || "10001";
      this.partnerId = urlParams.get('partner_id') || "10002";
      const nameParam = urlParams.get('name');
      this.name = nameParam ? ` - ${nameParam} peer` : " - Unknown peer";
      
      this.peer = new Peer(this.myId);
      
      this.peer.on('connection', conn => {
        this.conn = conn;
        this.handleConnection();
      });
    },
    methods: {
      connect() {
        if (this.isConnected) {
          this.disconnect();
        } else if (!this.isConnected && this.partnerId) {
          this.conn = this.peer.connect(this.partnerId);
          this.handleConnection();
        }
      },
      disconnect() {
        if (this.conn) {
          this.conn.close();
          this.conn = null;
          this.isConnected = false;
          this.status = 'Disconnected';
        }
      },
      handleConnection() {
        this.conn.on('open', () => {
          this.isConnected = true;
          this.status = `Connected to: ${this.conn.peer}`;
        });
        this.conn.on('data', (data) => {
          const currentTime = new Date().toTimeString().split(" ")[0];
          const receivedMessage = `${currentTime} - Received: ${data}`;
          this.receivedMessages.push({ message: receivedMessage, sender: false });
        });
        this.conn.on('close', () => {
          this.isConnected = false;
          this.status = 'Disconnected';
          this.conn = null;
        });
        this.conn.on('error', (err) => {
          this.isConnected = false;
          this.status = `Connection failed: ${err}`;
        });
      }
    }

  }).mount('#app');
  </script>  
</body>
</html>
